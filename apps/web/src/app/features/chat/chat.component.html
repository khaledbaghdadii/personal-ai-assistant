<div class="flex flex-col h-full bg-gray-50">
    <!-- Toolbar -->
    <mat-toolbar color="primary" class="chat-toolbar">
        <mat-icon class="mr-3">smart_toy</mat-icon>
        <span class="font-medium text-lg tracking-wide">AI Planner</span>
        <span class="spacer"></span>
        <div class="session-badge">
            <mat-icon class="text-xs !w-4 !h-4 !min-w-4 text-white/70">key</mat-icon>
            <span class="text-sm font-medium text-white/90">{{sessionId()}}</span>
        </div>
        <button mat-icon-button (click)="onNewSession()" class="ml-2 text-white/80 hover:text-white"
            matTooltip="New Session">
            <mat-icon>add_circle_outline</mat-icon>
        </button>
    </mat-toolbar>

    <!-- Messages Area -->
    <div class="flex-1 overflow-y-auto p-4 md:p-6 space-y-6 scroll-smooth bg-gray-50" #scrollContainer>
        @if (messages().length === 0) {
        <div class="empty-state">
            <mat-icon class="empty-icon">chat_bubble_outline</mat-icon>
            <p class="text-xl font-medium tracking-tight">How can I help you today?</p>
        </div>
        }

        @for (msg of messages(); track msg) {
        <div class="flex w-full animate-slide-up" [class.justify-end]="msg.role === 'user'">
            <div [class]="'message-bubble ' + 
                            (msg.role === 'user' 
                              ? 'bg-blue-600 text-white rounded-br-none shadow-blue-200' 
                              : 'bg-white text-gray-800 border border-gray-100 rounded-bl-none')">
                @if(msg.role === 'user') {
                <p class="whitespace-pre-wrap leading-relaxed">{{msg.content}}</p>
                } @else {
                <markdown [data]="msg.content"
                    class="prose prose-sm max-w-none prose-p:my-1 prose-headings:my-2 prose-pre:bg-gray-50 prose-a:text-blue-600">
                </markdown>
                }
            </div>
        </div>
        }

        @if (isLoading()) {
        <div class="flex justify-start w-full animate-fade-in">
            <div class="loading-bubble">
                <div class="dot delay-0"></div>
                <div class="dot delay-75"></div>
                <div class="dot delay-150"></div>
            </div>
        </div>
        }
    </div>

    <!-- Input Area -->
    <div class="input-area">
        <div class="input-container">
            <mat-form-field appearance="outline" subscriptSizing="dynamic" class="flex-1">
                <mat-label>Message Agent...</mat-label>
                <input matInput [(ngModel)]="chatInput" (keydown.enter)="sendMessage()" [disabled]="isLoading()"
                    autocomplete="off">
                @if (chatInput) {
                <button mat-icon-button matSuffix (click)="chatInput = ''" matTooltip="Clear">
                    <mat-icon>close</mat-icon>
                </button>
                }
            </mat-form-field>

            <button mat-fab color="primary" (click)="sendMessage()" [disabled]="!chatInput.trim() || isLoading()"
                class="send-button">
                <mat-icon>{{ isLoading() ? 'hourglass_empty' : 'send' }}</mat-icon>
            </button>
        </div>
        <div class="text-center mt-2">
            <span class="text-xs text-gray-400">Press Enter to send</span>
        </div>
    </div>
</div>